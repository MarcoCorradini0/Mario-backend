name: Build Native Binary & Release (TURBO)

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-native:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # 1) Checkout
      # ----------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # ----------------------------
      # 2) Maven cache
      # ----------------------------
      - name: Cache Maven repository
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      # ----------------------------
      # 3) Setup GraalVM 21
      # (native-image incluso, niente "components")
      # ----------------------------
      - name: Set up GraalVM 21
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm'

      - name: Make mvnw executable
        run: chmod +x mvnw

      # ----------------------------
      # 4) Build Native TURBO
      # - Quick Build Mode (-Ob)
      # - GC: G1
      # ----------------------------
      - name: Build native executable (Turbo)
        run: ./mvnw -Pnative clean package \
             -DskipTests \
             -Dquarkus.native.additional-build-args="--gc=G1,-Ob"

      # ----------------------------
      # 5) Debug target
      # ----------------------------
      # - name: Show target folder
      #   run: ls -lah ./target || true

      # ----------------------------
      # 6) Trova il binario *-runner
      # ----------------------------
      - name: Find native runner
        id: find_runner
        shell: bash
        run: |
          FILE=$(ls -1 target/*-runner 2>/dev/null | head -n 1 || true)
          if [ -z "$FILE" ]; then
            echo "Runner non trovato in target/*-runner"
            exit 1
          fi
          echo "Found runner: $FILE"
          echo "runner_path=$FILE" >> $GITHUB_OUTPUT

      # ----------------------------
      # 7) Rinomina il binary â†’ "app"
      # ----------------------------
      - name: Prepare release asset
        run: |
          cp "${{ steps.find_runner.outputs.runner_path }}" app
          chmod +x app

      # ----------------------------
      # 8) Crea release senza warning
      # ----------------------------
      - name: Create/Update release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: native-latest
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------
      # 9) Carica asset "app" nella Release
      # ----------------------------
      - name: Upload native 'app' asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: native-latest
          files: app
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}